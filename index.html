<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0f2027" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>Tandis AI</title>
    <link rel="icon" sizes="192x192" href="icons/icon-192.png" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    <link rel="manifest" href="manifest.json" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: light dark;
        --bg: radial-gradient(circle at top, #192734, #0f2027 55%);
        --panel: rgba(13, 25, 34, 0.65);
        --panel-border: rgba(255, 255, 255, 0.08);
        --text: #f8fbff;
        --muted: rgba(248, 251, 255, 0.72);
        --accent: #7ef9c2;
        --shadow: rgba(0, 0, 0, 0.25);
        --input-bg: rgba(255, 255, 255, 0.08);
        --input-border: rgba(255, 255, 255, 0.15);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background-image: var(--bg);
        background-attachment: fixed;
        color: var(--text);
        display: flex;
        align-items: stretch;
        justify-content: center;
        padding: clamp(1rem, 3vw, 2.5rem);
      }

      main {
        width: min(960px, 100%);
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
      }

      .panel {
        padding: clamp(1.25rem, 3vw, 2.25rem);
        background: var(--panel);
        border-radius: 24px;
        border: 1px solid var(--panel-border);
        box-shadow: 0 25px 60px var(--shadow);
        backdrop-filter: blur(20px) saturate(140%);
      }

      .shell {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
      }

      h1 {
        margin: 0 0 0.35rem;
        font-size: clamp(2rem, 6vw, 2.8rem);
        letter-spacing: -0.02em;
      }

      h2 {
        margin: 0;
        font-size: 1.4rem;
      }

      h3 {
        margin: 0;
        font-size: 1rem;
      }

      p {
        margin: 0;
        line-height: 1.5;
        color: var(--muted);
      }

      .eyebrow {
        display: inline-flex;
        gap: 0.4rem;
        align-items: center;
        padding: 0.35rem 0.85rem;
        border-radius: 999px;
        border: 1px solid rgba(248, 251, 255, 0.25);
        text-transform: uppercase;
        letter-spacing: 0.2em;
        font-size: 0.65rem;
        color: var(--muted);
        margin-bottom: 0.65rem;
      }

      .user-pill {
        display: flex;
        align-items: center;
        gap: 0.9rem;
        padding: 0.8rem 1.2rem;
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .user-pill strong {
        display: block;
      }

      .user-pill button {
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: transparent;
        color: var(--text);
        border-radius: 999px;
        padding: 0.4rem 0.9rem;
        font-size: 0.85rem;
        cursor: pointer;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        width: 100%;
        margin-top: 1rem;
      }

      label {
        font-size: 0.8rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--muted);
      }

      input {
        width: 100%;
        border: 1px solid var(--input-border);
        border-radius: 18px;
        padding: 0.9rem 1rem;
        font-size: 1rem;
        background: var(--input-bg);
        color: var(--text);
      }

      input::placeholder {
        color: rgba(248, 251, 255, 0.45);
      }

      button.primary {
        border: none;
        padding: 0.9rem 1.8rem;
        border-radius: 999px;
        font-size: 1rem;
        font-weight: 600;
        font-family: inherit;
        color: #041018;
        background: var(--accent);
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 18px 35px rgba(126, 249, 194, 0.35);
      }

      button.primary:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        box-shadow: none;
      }

      button.primary:active {
        transform: scale(0.98);
      }

      .status {
        font-size: 0.85rem;
        min-height: 1.2rem;
        color: var(--muted);
      }

      .workspace {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
      }

      @media (min-width: 1024px) {
        .workspace {
          display: grid;
          grid-template-columns: minmax(0, 0.9fr) minmax(0, 1.1fr);
          gap: 1.25rem;
        }
      }

      .orders-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
      }

      #orders-btn {
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: transparent;
        color: var(--text);
        border-radius: 999px;
        padding: 0.5rem 1.1rem;
        cursor: pointer;
      }

      #orders-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .orders-list {
        margin-top: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .order-block {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .order-detail {
        display: none;
      }

      .order-detail.is-open {
        display: block;
      }

      @media (max-width: 1023px) {
        #detail-panel {
          display: none;
        }
      }

      @media (min-width: 1024px) {
        .order-detail {
          display: none !important;
        }
      }

      @media (max-width: 640px) {
        .order-card {
          padding: 0.8rem;
        }
        .detail-card {
          padding: 0.85rem;
        }
        .panel {
          padding: 1rem;
        }
        .summary-grid {
          grid-template-columns: 1fr;
        }
      }

      .orders-list .empty {
        font-size: 0.95rem;
        color: var(--muted);
      }

      .order-card {
        width: 100%;
        text-align: left;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 18px;
        padding: 0.9rem 1rem;
        background: rgba(255, 255, 255, 0.03);
        color: inherit;
        font: inherit;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        transition: border 0.2s ease, transform 0.2s ease;
      }

      .order-card.active {
        border-color: var(--accent);
        box-shadow: 0 12px 35px rgba(126, 249, 194, 0.25);
      }

      .order-card strong {
        font-size: 1rem;
      }

      .order-meta-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .order-status-pill {
        display: inline-flex;
        padding: 0.2rem 0.75rem;
        border-radius: 999px;
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        background: rgba(126, 249, 194, 0.18);
        border: 1px solid rgba(126, 249, 194, 0.4);
      }

      #detail-panel {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .detail-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      @media (min-width: 640px) {
        .detail-grid {
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
      }

      @media (min-width: 900px) {
        .detail-grid {
          grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        }
      }

      .detail-card {
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 18px;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.03);
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
      }

      .detail-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
      }

      .section-status {
        font-size: 0.75rem;
        color: var(--muted);
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 0.6rem;
        font-size: 0.9rem;
      }

      .summary-grid span {
        display: block;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }

      .detail-items {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .detail-item {
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 14px;
        padding: 0.75rem;
        background: rgba(0, 0, 0, 0.15);
        display: flex;
        justify-content: space-between;
        gap: 0.8rem;
        font-size: 0.9rem;
        flex-wrap: wrap;
      }

      .detail-item p {
        margin-top: 0.2rem;
        color: var(--muted);
        font-size: 0.85rem;
      }

      .detail-item button {
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: transparent;
        color: var(--text);
        border-radius: 999px;
        padding: 0.35rem 0.85rem;
        cursor: pointer;
        font-size: 0.8rem;
        white-space: nowrap;
      }

      .empty-state {
        font-size: 0.9rem;
        color: var(--muted);
      }

      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <main>
      <section class="panel shell">
        <div>
          <span class="eyebrow">Tandis AI</span>
          <h1>Command center</h1>
          <p>Track orders, services, tasks, attachments, and comments.</p>
        </div>
        <div class="user-pill" style="gap:0.75rem; flex-wrap:wrap;">
          <div style="min-width:160px;">
            <p class="label" style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.1em;">Signed in as</p>
            <strong id="user-name">Not signed in</strong>
          </div>
          <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
            <button type="button" id="refresh-app-btn" disabled>Refresh app</button>
            <button type="button" id="sign-out-btn" disabled>Sign out</button>
          </div>
        </div>
      </section>

      <section class="panel" id="login-panel">
        <h2>Sign in</h2>
        <p>Use your BMC Remedy credentials to retrieve a secure token.</p>
        <form id="login-form">
          <div>
            <label for="username">Username</label>
            <input
              id="username"
              name="username"
              type="email"
              autocomplete="username"
              placeholder="user@company.com"
              autocapitalize="none"
              autocorrect="off"
              spellcheck="false"
              inputmode="email"
              required
            />
          </div>
          <div>
            <label for="password">Password</label>
            <input
              id="password"
              name="password"
              type="password"
              autocomplete="current-password"
              placeholder="••••••••"
              required
            />
          </div>
          <button type="submit" id="login-btn" class="primary">Sign in</button>
          <div class="status" id="status-msg"></div>
        </form>
      </section>

      <div class="workspace">
        <section class="panel" id="orders-panel">
          <div class="orders-header">
            <div>
              <span class="eyebrow">Latest 10 orders</span>
              <h2>Orders</h2>
            </div>
            <button type="button" id="orders-btn" disabled>Refresh</button>
          </div>
          <div class="status" id="orders-status">Sign in to load orders.</div>
          <div class="orders-list" id="orders-list"></div>
        </section>

        <section class="panel" id="detail-panel">
          <div class="orders-header">
            <div>
              <span class="eyebrow">Order detail</span>
              <h2 id="detail-title">Select an order</h2>
              <p id="detail-subtitle">Choose an order to load services, tasks, attachments, and comments.</p>
            </div>
          </div>
          <div class="detail-grid">
            <article class="detail-card">
              <div class="detail-head">
                <h3>Summary</h3>
                <span class="section-status" id="summary-status">Awaiting selection</span>
              </div>
              <div class="summary-grid" id="summary-list"></div>
            </article>
            <article class="detail-card">
              <div class="detail-head">
                <h3>Services</h3>
                <span class="section-status" id="services-status">Awaiting selection</span>
              </div>
              <div id="services-list" class="detail-items"></div>
            </article>
            <article class="detail-card">
              <div class="detail-head">
                <h3>Tasks</h3>
                <span class="section-status" id="tasks-status">Awaiting selection</span>
              </div>
              <div id="tasks-list" class="detail-items"></div>
            </article>
            <article class="detail-card">
              <div class="detail-head">
                <h3>Materials</h3>
                <span class="section-status" id="materials-status">Awaiting selection</span>
              </div>
              <div id="materials-list" class="detail-items"></div>
            </article>
            <article class="detail-card">
              <div class="detail-head">
                <h3>Attachments</h3>
                <span class="section-status" id="attachments-status">Awaiting selection</span>
              </div>
              <div id="attachments-list" class="detail-items"></div>
            </article>
            <article class="detail-card" style="grid-column: 1 / -1;">
              <div class="detail-head">
                <h3>Comments</h3>
                <span class="section-status" id="comments-status">Awaiting selection</span>
              </div>
              <div id="comments-list" class="detail-items"></div>
            </article>
          </div>
        </section>
      </div>
    </main>


    <script>
      const API_BASE = window.location.hostname === 'localhost'
        ? ''
        : 'https://lexicostatistical-seamanly-elle.ngrok-free.dev';
      const DESKTOP_BREAKPOINT = 1024;

      const state = {
        token: '',
        user: '',
        orders: [],
        selectedOrderId: null,
        details: {},
        loadingDetails: {}
      };

      const form = document.getElementById('login-form');
      const loginPanel = document.getElementById('login-panel');
      const statusMsg = document.getElementById('status-msg');
      const loginBtn = document.getElementById('login-btn');
      const ordersBtn = document.getElementById('orders-btn');
      const ordersStatus = document.getElementById('orders-status');
      const ordersList = document.getElementById('orders-list');
      const userNameEl = document.getElementById('user-name');
      const signOutBtn = document.getElementById('sign-out-btn');
      const refreshAppBtn = document.getElementById('refresh-app-btn');

      const detailTitle = document.getElementById('detail-title');
      const detailSubtitle = document.getElementById('detail-subtitle');
      const summaryStatus = document.getElementById('summary-status');
      const summaryList = document.getElementById('summary-list');
      const servicesStatus = document.getElementById('services-status');
      const servicesList = document.getElementById('services-list');
      const tasksStatus = document.getElementById('tasks-status');
      const tasksList = document.getElementById('tasks-list');
      const materialsStatus = document.getElementById('materials-status');
      const materialsList = document.getElementById('materials-list');
      const attachmentsStatus = document.getElementById('attachments-status');
      const attachmentsList = document.getElementById('attachments-list');
      const commentsStatus = document.getElementById('comments-status');
      const commentsList = document.getElementById('comments-list');

      form.addEventListener('submit', handleLogin);
      ordersBtn.addEventListener('click', () => fetchOrders(true));
      signOutBtn.addEventListener('click', () => window.location.reload());
      refreshAppBtn.addEventListener('click', forceRefresh);
      ordersList.addEventListener('click', (event) => {
        const card = event.target.closest('.order-card');
        if (!card) return;
        const orderId = card.dataset.orderId;
        const order = state.orders.find((entry) => entry.ID === orderId);
        if (order) {
          selectOrder(order);
        }
      });
      document.addEventListener('click', (event) => {
        const btn = event.target.closest('.download-btn');
        if (!btn) return;
        const attachmentId = btn.dataset.attachmentId;
        if (!attachmentId) return;
        const fileName = btn.dataset.fileName;
        downloadAttachment(attachmentId, fileName, btn);
      });

      resetDetailPanel();

      async function handleLogin(event) {
        event.preventDefault();
        const formData = new FormData(form);
        const username = formData.get('username');
        const password = formData.get('password');

        if (!username || !password) {
          statusMsg.textContent = 'Please provide both username and password.';
          return;
        }

        loginBtn.disabled = true;
        statusMsg.textContent = 'Signing in…';

        try {
          const token = await post('/api/bmc-token', { username, password }, { expect: 'text' });
          const trimmed = token.trim();
          if (!trimmed) {
            throw new Error('Empty token response.');
          }
          state.token = trimmed;
          state.user = username;
          userNameEl.textContent = username;
          signOutBtn.disabled = false;
          refreshAppBtn.disabled = false;
          loginPanel.classList.add('hidden');
          statusMsg.textContent = 'Signed in. Fetching orders…';
          ordersBtn.disabled = false;
          await fetchOrders();
          document.getElementById('orders-panel').scrollIntoView({ behavior: 'smooth', block: 'start' });
        } catch (error) {
          statusMsg.textContent = error.message || 'Login failed.';
        } finally {
          loginBtn.disabled = false;
        }
      }

      async function fetchOrders(manual = false) {
        if (!state.token) return;
        ordersBtn.disabled = true;
        ordersStatus.textContent = manual ? 'Refreshing orders…' : 'Loading orders…';
        ordersList.innerHTML = '';

        try {
          const data = await post('/api/orders', { token: state.token });
          const entries = Array.isArray(data?.entries) ? data.entries : [];
          state.orders = entries.map((entry) => entry.values || {});
          const validIds = new Set(state.orders.map((order) => order.ID));
          Object.keys(state.details).forEach((id) => {
            if (!validIds.has(id)) {
              delete state.details[id];
              delete state.loadingDetails[id];
            }
          });
          renderOrders();
          if (!state.orders.length) {
            ordersStatus.textContent = 'No orders returned.';
            state.selectedOrderId = null;
            resetDetailPanel('No orders available.');
          } else {
            ordersStatus.textContent = `Updated · ${new Date().toLocaleTimeString()}`;
            const current = state.selectedOrderId
              ? state.orders.find((order) => order.ID === state.selectedOrderId)
              : state.orders[0];
            if (current) {
              await selectOrder(current, { preserveScroll: true });
            }
          }
        } catch (error) {
          ordersStatus.textContent = error.message || 'Failed to load orders.';
        } finally {
          ordersBtn.disabled = !state.token;
        }
      }

      function renderOrders() {
        ordersList.innerHTML = '';
        if (!state.orders.length) {
          ordersList.innerHTML = '<p class="empty">Nothing to show yet.</p>';
          return;
        }

        state.orders.forEach((order) => {
          const block = document.createElement('div');
          block.className = 'order-block';

          const button = document.createElement('button');
          button.type = 'button';
          button.className = `order-card${state.selectedOrderId === order.ID ? ' active' : ''}`;
          button.dataset.orderId = order.ID;
          button.innerHTML = `
            <strong>#${order.OrdernumberShort || order.ID || '—'}</strong>
            <div class="order-meta-row">
              <span>${order.Patient_FirstName || ''} ${order.Patient_LastName || ''}</span>
              <span>${order.ClinicName || '—'}</span>
            </div>
            <div class="order-meta-row" style="justify-content: space-between;">
              <span title="Created">${formatDate(order['Create Date'])}</span>
              <span class="order-status-pill">${order.StatusName || 'Unknown'}</span>
            </div>
          `;

          const detail = document.createElement('div');
          detail.className = 'order-detail';
          detail.dataset.orderId = order.ID;
          if (state.selectedOrderId === order.ID) {
            detail.classList.add('is-open');
            if (state.loadingDetails[order.ID]) {
              detail.innerHTML = '<p class="empty-state">Loading details…</p>';
            } else if (state.details[order.ID]) {
              detail.innerHTML = '';
              detail.appendChild(buildInlineDetailContent(order, state.details[order.ID]));
            } else {
              detail.innerHTML = '<p class="empty-state">Select the order to load details.</p>';
            }
          }

          block.appendChild(button);
          block.appendChild(detail);
          ordersList.appendChild(block);
        });
      }

      async function selectOrder(order, options = {}) {
        if (!order) return;
        state.selectedOrderId = order.ID;
        renderOrders();
        renderSummarySection(order);

        if (state.details[order.ID] && !options.forceReload) {
          renderDesktopDetail(order, state.details[order.ID]);
          if (!options.preserveScroll) {
            scrollToDetail(order.ID);
          }
          return;
        }

        setSectionsLoading();
        state.loadingDetails[order.ID] = true;
        renderOrders();

        try {
          const details = await fetchOrderDetails(order);
          state.details[order.ID] = details;
          renderDesktopDetail(order, details);
        } catch (error) {
          const message = error?.message || 'Failed to load order details.';
          state.details[order.ID] = {
            services: [],
            servicesError: message,
            tasks: [],
            tasksError: message,
            materials: [],
            materialsError: message,
            attachments: [],
            attachmentsError: message,
            comments: [],
            commentsError: message
          };
          setSectionsError(message);
        } finally {
          state.loadingDetails[order.ID] = false;
          renderOrders();
          if (!options.preserveScroll) {
            scrollToDetail(order.ID);
          }
        }
      }

      function renderSummarySection(order) {
        detailTitle.textContent = `Order #${order.OrdernumberShort || order.ID}`;
        const subtitleLab = order.Lab_Name || 'Unknown lab';
        const subtitleClinic = order.ClinicName || 'Unknown clinic';
        const subtitleDept = order.DepartmentName ? ` · ${order.DepartmentName}` : '';
        detailSubtitle.textContent = `${subtitleClinic} · ${subtitleLab}${subtitleDept}`;

        const summary = buildSummarySection(order);
        orderDetailCache.set(order.ID, summary);
        summaryStatus.textContent = summary.status;
        summaryList.innerHTML = summary.html;
      }

      function setSectionsLoading() {
        const sections = [
          { statusEl: servicesStatus, listEl: servicesList },
          { statusEl: tasksStatus, listEl: tasksList },
          { statusEl: materialsStatus, listEl: materialsList },
          { statusEl: attachmentsStatus, listEl: attachmentsList },
          { statusEl: commentsStatus, listEl: commentsList }
        ];
        sections.forEach(({ statusEl, listEl }) => {
          statusEl.textContent = 'Loading…';
          listEl.innerHTML = '';
        });
      }

      function setSectionsError(message) {
        const html = `<p class="empty-state">${message}</p>`;
        const sections = [
          { statusEl: servicesStatus, listEl: servicesList },
          { statusEl: tasksStatus, listEl: tasksList },
          { statusEl: materialsStatus, listEl: materialsList },
          { statusEl: attachmentsStatus, listEl: attachmentsList },
          { statusEl: commentsStatus, listEl: commentsList }
        ];
        sections.forEach(({ statusEl, listEl }) => {
          statusEl.textContent = 'Error';
          listEl.innerHTML = html;
        });
      }

      async function fetchOrderDetails(order) {
        const requests = [
          post('/api/order-services', { token: state.token, orderId: order.ID }),
          post('/api/order-tasks', { token: state.token, orderId: order.ID }),
          post('/api/order-materials', { token: state.token, orderId: order.ID }),
          post('/api/order-attachments-list', { token: state.token, orderId: order.ID }),
          post('/api/order-comments', { token: state.token, orderId: order.ID })
        ];

        const [servicesRes, tasksRes, materialsRes, attachmentsRes, commentsRes] = await Promise.allSettled(requests);

        return {
          services: servicesRes.status === 'fulfilled' ? extractEntries(servicesRes.value) : [],
          servicesError: servicesRes.status === 'rejected' ? getErrorMessage(servicesRes.reason) : null,
          tasks: tasksRes.status === 'fulfilled' ? extractEntries(tasksRes.value) : [],
          tasksError: tasksRes.status === 'rejected' ? getErrorMessage(tasksRes.reason) : null,
          materials: materialsRes.status === 'fulfilled' ? extractEntries(materialsRes.value) : [],
          materialsError: materialsRes.status === 'rejected' ? getErrorMessage(materialsRes.reason) : null,
          attachments: attachmentsRes.status === 'fulfilled' ? extractEntries(attachmentsRes.value) : [],
          attachmentsError: attachmentsRes.status === 'rejected' ? getErrorMessage(attachmentsRes.reason) : null,
          comments: commentsRes.status === 'fulfilled' ? extractEntries(commentsRes.value) : [],
          commentsError: commentsRes.status === 'rejected' ? getErrorMessage(commentsRes.reason) : null
        };
      }

      function getDetailSections(order, details = {}) {
        return [
          buildSummarySection(order),
          buildServicesSection(details.services || [], details.servicesError),
          buildTasksSection(details.tasks || [], details.tasksError),
          buildMaterialsSection(details.materials || [], details.materialsError),
          buildAttachmentsSection(details.attachments || [], details.attachmentsError),
          buildCommentsSection(details.comments || [], details.commentsError)
        ];
      }

      function renderDesktopDetail(order, details = {}) {
        const sections = getDetailSections(order, details);
        sections.forEach((section) => {
          switch (section.title) {
            case 'Summary':
              summaryStatus.textContent = section.status;
              summaryList.innerHTML = section.html;
              break;
            case 'Services':
              servicesStatus.textContent = section.status;
              servicesList.innerHTML = section.html;
              break;
            case 'Tasks':
              tasksStatus.textContent = section.status;
              tasksList.innerHTML = section.html;
              break;
            case 'Materials':
              materialsStatus.textContent = section.status;
              materialsList.innerHTML = section.html;
              break;
            case 'Attachments':
              attachmentsStatus.textContent = section.status;
              attachmentsList.innerHTML = section.html;
              break;
            case 'Comments':
              commentsStatus.textContent = section.status;
              commentsList.innerHTML = section.html;
              break;
            default:
              break;
          }
        });
      }

      function buildInlineDetailContent(order, details = {}) {
        const fragment = document.createDocumentFragment();
        const sections = getDetailSections(order, details);
        sections.forEach((section) => {
          const card = document.createElement('article');
          card.className = 'detail-card';
          card.innerHTML = `
            <div class="detail-head">
              <h3>${section.title}</h3>
              <span class="section-status">${section.status}</span>
            </div>
            ${section.html}
          `;
          fragment.appendChild(card);
        });
        return fragment;
      }

      const orderDetailCache = new Map();

      function buildSummarySection(order) {
        const items = [
          { label: 'Patient', value: `${order.Patient_FirstName || ''} ${order.Patient_LastName || ''}`.trim() || '—' },
          { label: 'Patient ID', value: order.Patient_PersonID || '—' },
          { label: 'Clinic', value: order.ClinicName || '—' },
          { label: 'Lab', value: order.Lab_Name || '—' },
          { label: 'Department', value: order.DepartmentName || '—' },
          { label: 'Status', value: order.StatusName || '—' },
          { label: 'Created', value: formatDate(order['Create Date']) },
          { label: 'Updated', value: formatDate(order['Modified Date']) },
          { label: 'Total price', value: formatMoney(order.OrderPrice, order.Currency || 'SEK', order.PriceInSek) },
          { label: 'Description', value: order.Order_Description || '—' }
        ];

        const html = `
          <div class="summary-grid">
            ${items
              .map((item) => `
                <div>
                  <span>${item.label}</span>
                  <strong style="display:block; margin-top:0.2rem; font-size:0.95rem;">${item.value}</strong>
                </div>
              `)
              .join('')}
          </div>
        `;
        return { title: 'Summary', status: 'Loaded', html };
      }

      function buildServicesSection(services, error) {
        if (error) {
          return { title: 'Services', status: 'Error', html: `<p class="empty-state">${error}</p>` };
        }
        if (!services.length) {
          return { title: 'Services', status: 'No services', html: '<p class="empty-state">No services found.</p>' };
        }
        const html = services
          .map((service) => `
            <div class="detail-item">
              <div>
                <strong>${service.ServiceName || 'Service'}</strong>
                <p>${service.ServiceDescription || ''}</p>
              </div>
              <div style="text-align:right;">
                <strong>${formatAmount(service.Amount, service.Unit)}</strong>
                <p>${formatMoney(service.Price, service.Currency)}</p>
              </div>
            </div>
          `)
          .join('');
        return { title: 'Services', status: `${services.length} service(s)`, html };
      }

      function buildTasksSection(tasks, error) {
        if (error) {
          return { title: 'Tasks', status: 'Error', html: `<p class="empty-state">${error}</p>` };
        }
        if (!tasks.length) {
          return { title: 'Tasks', status: 'No tasks', html: '<p class="empty-state">No active tasks.</p>' };
        }
        const sorted = [...tasks].sort((a, b) => {
          const sortA = Number(a.SortOrder ?? a['Sort Order'] ?? Infinity);
          const sortB = Number(b.SortOrder ?? b['Sort Order'] ?? Infinity);
          if (sortA !== sortB) return sortA - sortB;
          const reqA = (a['Request ID'] || a.RequestID || '').toString();
          const reqB = (b['Request ID'] || b.RequestID || '').toString();
          return reqA.localeCompare(reqB);
        });
        const html = sorted
          .map((task) => `
            <div class="detail-item">
              <div>
                <strong>${task.TaskName || 'Task'}</strong>
                <p>${task.DepartmentName || '—'}</p>
              </div>
              <div style="text-align:right;">
                <span class="order-status-pill" style="margin-bottom:0.35rem; display:inline-flex;">${task.StatusTask || '—'}</span>
                <p>${task.AssigneeFullName || ''}</p>
              </div>
            </div>
          `)
          .join('');
        return { title: 'Tasks', status: `${tasks.length} task(s)`, html };
      }

      function buildMaterialsSection(materials, error) {
        if (error) {
          return { title: 'Materials', status: 'Error', html: `<p class="empty-state">${error}</p>` };
        }
        if (!materials.length) {
          return { title: 'Materials', status: 'No materials', html: '<p class="empty-state">No materials logged.</p>' };
        }
        const html = materials
          .map((material) => {
            const batch = material.BatchNumber ? `Batch ${material.BatchNumber}` : '';
            return `
              <div class="detail-item">
                <div>
                  <strong>${material.MaterialCode || 'Material'} · ${material.MaterialName || ''}</strong>
                  <p>${batch}</p>
                </div>
                <div style="text-align:right;">
                  <strong>${formatAmount(material.AmountMaterial, material.UnitMaterial)}</strong>
                  <p>${formatMoney(material.PriceMaterial, material.Currency || 'SEK', material.PriceInSek)}</p>
                </div>
              </div>
            `;
          })
          .join('');
        return { title: 'Materials', status: `${materials.length} item(s)`, html };
      }

      function buildAttachmentsSection(attachments, error) {
        if (error) {
          return { title: 'Attachments', status: 'Error', html: `<p class="empty-state">${error}</p>` };
        }
        if (!attachments.length) {
          return { title: 'Attachments', status: 'No attachments', html: '<p class="empty-state">No attachments uploaded.</p>' };
        }
        const html = attachments
          .map((attachment) => {
            const requestId = attachment['Request ID'] || attachment.RequestID || attachment.Request_Id;
            const created = formatDate(attachment['Create Date']);
            const fileName = getAttachmentName(attachment.Attachment_File);
            const disabled = requestId ? '' : 'disabled';
            return `
              <div class="detail-item">
                <div>
                  <strong>${fileName}</strong>
                  <p>${created}</p>
                </div>
                <button type="button" class="download-btn" data-attachment-id="${requestId || ''}" data-file-name="${fileName}" ${disabled}>
                  ${requestId ? 'Download' : 'Unavailable'}
                </button>
              </div>
            `;
          })
          .join('');
        return { title: 'Attachments', status: `${attachments.length} attachment(s)`, html };
      }

      function buildCommentsSection(comments, error) {
        if (error) {
          return { title: 'Comments', status: 'Error', html: `<p class="empty-state">${error}</p>` };
        }
        if (!comments.length) {
          return { title: 'Comments', status: 'No comments', html: '<p class="empty-state">No chat history.</p>' };
        }
        const html = comments
          .map((comment) => {
            const text = pickField(comment, ['Comment_Text', 'CommentText', 'Comment', 'Comments', 'OrderComment', 'Description'], '(no text)');
            const author = pickField(comment, ['Author', 'AuthorName', 'FullName', 'Created By', 'Last Modified By'], 'Unknown user');
            const timestamp = formatDate(pickField(comment, ['Create Date', 'Modified Date', 'Last Modified Date', 'CreateDate']));
            return `
              <div class="detail-item" style="flex-direction: column;">
                <div style="display:flex; justify-content:space-between; gap:0.5rem;">
                  <strong>${author}</strong>
                  <span style="font-size:0.75rem; color:var(--muted);">${timestamp}</span>
                </div>
                <p>${text}</p>
              </div>
            `;
          })
          .join('');
        return { title: 'Comments', status: `${comments.length} message(s)`, html };
      }

      function scrollToDetail(orderId) {
        if (isDesktopView()) {
          document.getElementById('detail-panel').scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
          const inline = ordersList.querySelector(`.order-detail[data-order-id="${orderId}"]`);
          inline?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      function extractEntries(data) {
        if (!data || !Array.isArray(data.entries)) return [];
        return data.entries.map((entry) => entry.values || {});
      }

      function formatAmount(amount, unit) {
        const value = amount == null ? '—' : Number(amount).toString();
        return `${value} ${unit || ''}`.trim();
      }

      function formatMoney(value, currency, fallbackSek) {
        if (value == null || value === '') {
          if (fallbackSek != null && fallbackSek !== '') {
            return `${fallbackSek} SEK`;
          }
          return '—';
        }
        return currency ? `${value} ${currency}` : `${value}`;
      }

      function formatDate(value) {
        if (!value) return '—';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
          return value;
        }
        return date.toLocaleString();
      }

      function getAttachmentName(field) {
        if (!field) return 'Attachment';
        if (typeof field === 'string') return field;
        return field.name || field.fileName || 'Attachment';
      }

      function getErrorMessage(error) {
        if (!error) return 'Unknown error';
        if (typeof error === 'string') return error;
        return error.message || 'Unknown error';
      }

      function pickField(obj, keys, fallback = '') {
        for (const key of keys) {
          if (obj && obj[key]) {
            return obj[key];
          }
        }
        return fallback;
      }

      async function downloadAttachment(attachmentId, fileName = 'attachment', button) {
        if (!attachmentId || !state.token) return;
        if (button) {
          button.disabled = true;
          button.textContent = 'Downloading…';
        }
        try {
          const response = await fetch(`${API_BASE}/api/order-attachment-file`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: state.token, attachmentId })
          });
          if (!response.ok) {
            throw new Error(`Download failed (${response.status})`);
          }
          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          const anchor = document.createElement('a');
          anchor.href = url;
          anchor.download = fileName || 'attachment';
          document.body.appendChild(anchor);
          anchor.click();
          anchor.remove();
          URL.revokeObjectURL(url);
        } catch (error) {
          alert(error.message || 'Download failed');
        } finally {
          if (button) {
            button.disabled = false;
            button.textContent = 'Download';
          }
        }
      }

      async function post(path, payload, { expect = 'json' } = {}) {
        const response = await fetch(`${API_BASE}${path}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          const text = await response.text();
          throw new Error(text || `Request failed (${response.status})`);
        }
        if (expect === 'text') {
          return response.text();
        }
        return response.json();
      }

      async function forceRefresh() {
        refreshAppBtn.disabled = true;
        refreshAppBtn.textContent = 'Refreshing…';
        try {
          if ('caches' in window) {
            const names = await caches.keys();
            await Promise.all(names.map((name) => caches.delete(name)));
          }
          if ('serviceWorker' in navigator) {
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all(regs.map((reg) => reg.unregister()));
          }
        } catch (error) {
          console.warn('Force refresh failed', error);
        } finally {
          window.location.reload();
        }
      }

      function isDesktopView() {
        return window.matchMedia(`(min-width: ${DESKTOP_BREAKPOINT}px)`).matches;
      }

      function resetDetailPanel(message = 'Choose an order to load services, tasks, materials, attachments, and comments.') {
        detailTitle.textContent = 'Select an order';
        detailSubtitle.textContent = message;
        summaryStatus.textContent = 'Awaiting selection';
        summaryList.innerHTML = '';
        const sections = [
          { statusEl: servicesStatus, listEl: servicesList },
          { statusEl: tasksStatus, listEl: tasksList },
          { statusEl: materialsStatus, listEl: materialsList },
          { statusEl: attachmentsStatus, listEl: attachmentsList },
          { statusEl: commentsStatus, listEl: commentsList }
        ];
        sections.forEach(({ statusEl, listEl }) => {
          statusEl.textContent = 'Awaiting selection';
          listEl.innerHTML = '';
        });
      }
    </script>

  </body>
</html>
