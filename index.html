<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0f2027" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>Tandis AI</title>
    <link rel="icon" sizes="192x192" href="icons/icon-192.png" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    <link rel="manifest" href="manifest.json" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: light dark;
        --bg: radial-gradient(circle at top, #192734, #0f2027 55%);
        --panel: rgba(13, 25, 34, 0.65);
        --panel-border: rgba(255, 255, 255, 0.08);
        --text: #f8fbff;
        --muted: rgba(248, 251, 255, 0.72);
        --accent: #7ef9c2;
        --shadow: rgba(0, 0, 0, 0.25);
        --input-bg: rgba(255, 255, 255, 0.08);
        --input-border: rgba(255, 255, 255, 0.15);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background-image: var(--bg);
        background-attachment: fixed;
        color: var(--text);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: clamp(1.25rem, 5vw, 3rem);
      }

      main {
        width: min(42rem, 100%);
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .panel {
        padding: clamp(1.5rem, 5vw, 2.5rem);
        background: var(--panel);
        border-radius: 26px;
        border: 1px solid var(--panel-border);
        box-shadow: 0 25px 60px var(--shadow);
        backdrop-filter: blur(20px) saturate(140%);
      }

      header {
        text-align: center;
      }

      h1 {
        margin: 0;
        font-size: clamp(2rem, 7vw, 2.8rem);
        letter-spacing: -0.02em;
      }

      .eyebrow {
        display: inline-flex;
        gap: 0.4rem;
        align-items: center;
        padding: 0.35rem 0.85rem;
        border-radius: 999px;
        border: 1px solid rgba(248, 251, 255, 0.25);
        text-transform: uppercase;
        letter-spacing: 0.2em;
        font-size: 0.7rem;
        color: var(--muted);
        margin-bottom: 0.65rem;
      }

      p {
        margin: 0;
        line-height: 1.5;
        color: var(--muted);
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        width: 100%;
        margin-top: 1rem;
      }

      label {
        font-size: 0.8rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--muted);
      }

      input {
        width: 100%;
        border: 1px solid var(--input-border);
        border-radius: 18px;
        padding: 0.9rem 1rem;
        font-size: 1rem;
        background: var(--input-bg);
        color: var(--text);
      }

      input::placeholder {
        color: rgba(248, 251, 255, 0.45);
      }

      button {
        border: none;
        padding: 0.9rem 1.8rem;
        border-radius: 999px;
        font-size: 1rem;
        font-weight: 600;
        font-family: inherit;
        color: #041018;
        background: var(--accent);
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 18px 35px rgba(126, 249, 194, 0.35);
      }

      button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        box-shadow: none;
      }

      button:active {
        transform: scale(0.98);
      }

      .status {
        font-size: 0.85rem;
        min-height: 1.2rem;
        color: var(--muted);
      }

      .orders-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .orders-list {
        margin-top: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
      }

      .order-card {
        border-radius: 18px;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 20px 35px rgba(0, 0, 0, 0.25);
      }

      .order-title {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .order-status {
        padding: 0.2rem 0.75rem;
        border-radius: 999px;
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        background: rgba(126, 249, 194, 0.18);
        border: 1px solid rgba(126, 249, 194, 0.4);
      }

      .order-meta {
        margin-top: 0.6rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(10rem, 1fr));
        gap: 0.5rem;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .order-description {
        margin-top: 0.6rem;
        font-size: 0.92rem;
        color: var(--text);
      }

      footer {
        text-align: center;
        font-size: 0.85rem;
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <main>
      <section class="panel">
        <header>
          <span class="eyebrow">Tandis AI</span>
          <h1>Orders at a glance</h1>
          <p>Sign in with your BMC Remedy credentials to sync the latest Tandis orders.</p>
        </header>
        <form id="login-form">
          <div>
            <label for="username">Username</label>
            <input
              id="username"
              name="username"
              type="email"
              autocomplete="username"
              placeholder="user@company.com"
              autocapitalize="none"
              autocorrect="off"
              spellcheck="false"
              inputmode="email"
              required
            />
          </div>
          <div>
            <label for="password">Password</label>
            <input
              id="password"
              name="password"
              type="password"
              autocomplete="current-password"
              placeholder="••••••••"
              required
            />
          </div>
          <button type="submit" id="login-btn">Sign in</button>
          <div class="status" id="status-msg"></div>
        </form>
      </section>

      <section class="panel" id="orders-section">
        <div class="orders-header">
          <div>
            <span class="eyebrow" style="font-size:0.65rem; letter-spacing:0.15em;">Latest 10 orders</span>
            <h2 style="margin:0; font-size:1.35rem;">Live queue</h2>
          </div>
          <button type="button" id="orders-btn" disabled>Refresh</button>
        </div>
        <div class="status" id="orders-status"></div>
        <div class="orders-list" id="orders-list"></div>
      </section>

      <footer>Powered by Tandis AI · 2026</footer>
    </main>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker
            .register('service-worker.js')
            .catch((err) => console.error('Service worker registration failed', err));
        });
      }

      const API_BASE = window.location.hostname === 'localhost'
        ? ''
        : 'https://lexicostatistical-seamanly-elle.ngrok-free.dev';

      const form = document.getElementById('login-form');
      const statusMsg = document.getElementById('status-msg');
      const loginBtn = document.getElementById('login-btn');
      const ordersBtn = document.getElementById('orders-btn');
      const ordersStatus = document.getElementById('orders-status');
      const ordersList = document.getElementById('orders-list');
      const ordersSection = document.getElementById('orders-section');

      let currentToken = '';
      let isFetchingOrders = false;

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        const username = formData.get('username');
        const password = formData.get('password');

        if (!username || !password) {
          statusMsg.textContent = 'Please provide both username and password.';
          return;
        }

        loginBtn.disabled = true;
        statusMsg.textContent = 'Signing in…';

        try {
          const response = await fetch(`${API_BASE}/api/bmc-token`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
          });

          const text = (await response.text()).trim();
          const ok = response.ok && text;
          statusMsg.textContent = ok ? 'Signed in. Fetching orders…' : `Error: ${response.status}`;
          currentToken = ok ? text : '';
          ordersBtn.disabled = !ok;

          if (ok) {
            await fetchOrders();
            ordersSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        } catch (error) {
          statusMsg.textContent = 'Server connection error.';
          currentToken = '';
          ordersBtn.disabled = true;
        } finally {
          loginBtn.disabled = false;
        }
      });

      ordersBtn.addEventListener('click', () => fetchOrders(true));

      async function fetchOrders(manual = false) {
        if (!currentToken || isFetchingOrders) return;

        isFetchingOrders = true;
        ordersBtn.disabled = true;
        ordersStatus.textContent = manual ? 'Refreshing orders…' : 'Loading orders…';
        ordersList.innerHTML = '';

        try {
          const response = await fetch(`${API_BASE}/api/orders`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: currentToken })
          });

          const text = await response.text();
          if (!response.ok) {
            ordersStatus.textContent = `Error: ${response.status}`;
            ordersList.textContent = text;
            return;
          }

          let payload;
          try {
            payload = JSON.parse(text);
          } catch (err) {
            ordersStatus.textContent = 'Unexpected response format.';
            ordersList.textContent = text;
            return;
          }

          const entries = payload?.entries || [];
          if (!entries.length) {
            ordersStatus.textContent = 'No orders returned.';
            return;
          }

          ordersStatus.textContent = `Updated · ${new Date().toLocaleTimeString()}`;
          entries.forEach(({ values }) => {
            const card = document.createElement('article');
            card.className = 'order-card';

            const title = document.createElement('div');
            title.className = 'order-title';
            title.innerHTML = `<strong>#${values?.OrdernumberShort || values?.ID || '—'}</strong>`;

            const status = document.createElement('span');
            status.className = 'order-status';
            status.textContent = values?.StatusName || 'Unknown';
            title.appendChild(status);

            const meta = document.createElement('div');
            meta.className = 'order-meta';
            meta.innerHTML = `
              <div><strong>Patient:</strong> ${values?.Patient_FirstName || ''} ${values?.Patient_LastName || ''}</div>
              <div><strong>Clinic:</strong> ${values?.ClinicName || '—'}</div>
              <div><strong>Lab:</strong> ${values?.Lab_Name || '—'}</div>
              <div><strong>Created:</strong> ${values?.['Create Date'] || '—'}</div>
              <div><strong>Updated:</strong> ${values?.['Modified Date'] || '—'}</div>
            `;

            const desc = document.createElement('p');
            desc.className = 'order-description';
            desc.textContent = values?.Order_Description || 'No description provided.';

            card.appendChild(title);
            card.appendChild(meta);
            card.appendChild(desc);
            ordersList.appendChild(card);
          });
        } catch (error) {
          ordersStatus.textContent = 'Server connection error.';
          ordersList.textContent = error.message;
        } finally {
          isFetchingOrders = false;
          ordersBtn.disabled = !currentToken;
        }
      }
    </script>
  </body>
</html>
